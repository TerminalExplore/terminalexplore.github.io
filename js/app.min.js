$(function() {
    var $window = $(window);
    var $room = $(".room");
    var $desktop = $(".desktop");
    var $apps = $(".apps");
    var $loginOverlay = $(".login-overlay");
    var $grid = $(".screenGrid");
    var $wallpaper = $(".wallpaper");
    var $info = $(".info");
    var $gif = $(".room-gif");
    var $wrap = $(".interactive-wrap");
    var $monitor = $(".monitor");
    var $noise = $(".noise");
    var resizeQueued = false;
    var scheduleFrame = window.requestAnimationFrame || function(callback) {
        return window.setTimeout(callback, 16);
    };

    $apps.hide();
    $loginOverlay.hide();
    $info.hide();
    $wallpaper.hide();

    $monitor.on("click", function() {
        $(".fa-hand-o-down").fadeOut(1000);
        $desktop.show();
        $room.addClass("zoom-out");
        $grid.stop(true, true).fadeIn(500);
        $apps.stop(true, true).fadeIn(500);
        $info.stop(true, true).fadeIn(500);
        $noise.stop(true, true).fadeIn(500);
        $desktop.addClass("zoom");
    });

    function detectIE() {
        var ua = window.navigator.userAgent;
        var msie = ua.indexOf("MSIE ");
        if (msie > 0) {
            return parseInt(ua.substring(msie + 5, ua.indexOf(".", msie)), 10);
        }

        var trident = ua.indexOf("Trident/");
        if (trident > 0) {
            var rv = ua.indexOf("rv:");
            return parseInt(ua.substring(rv + 3, ua.indexOf(".", rv)), 10);
        }

        var edge = ua.indexOf("Edge/");
        if (edge > 0) {
            return parseInt(ua.substring(edge + 5, ua.indexOf(".", edge)), 10);
        }

        return false;
    }

    var ieVersion = detectIE();

    function resizeRoom() {
        if (!window.jqueryResizeActive && ieVersion) {
            $room.css("height", window.innerHeight);
            $room.css("width", window.innerWidth);

            if ($room[0].clientHeight > window.innerHeight) {
                $gif.addClass("overflow");
            } else {
                $gif.removeClass("overflow");
            }

            $wrap.css("width", $gif.width());
            $wrap.css("height", $gif.height());
        }
    }

    function queueResizeRoom() {
        if (resizeQueued) {
            return;
        }
        resizeQueued = true;
        scheduleFrame(function() {
            resizeQueued = false;
            resizeRoom();
        });
    }

    resizeRoom();

    if (ieVersion) {
        $room.addClass("ie");
        resizeRoom();
    } else {
        $(".room-gif").addClass("scale-me");
        $(".monitor-svg").addClass("scale-me");
    }

    $window.on("resize.room", queueResizeRoom);
});

$(window).on("load", function() {
    setTimeout(function() {
        $(".logo-overlay").fadeOut(1500);
        $(".tcf-logo").addClass("fade-out");
        $(".page-state").removeClass("pulse").fadeOut(1000);
    }, 1000);
});

$(function() {
    var $window = $(window);
    var $room = $(".room");
    var $screen = $(".screen");
    var $logo = $(".logo");
    var $logoMenu = $(".logo-menu");
    var $shutdown = $(".shutdown");
    var $login = $(".login");
    var $loginOverlay = $(".login-overlay");
    var $close = $(".close-explorer");
    var $apps = $(".apps");
    var $info = $(".info");
    var $grid = $(".screenGrid");
    var $noise = $(".noise");

    var $trash = $(".trash");
    var $trashExplorer = $(".explorer-window.trash-explorer");

    var $about = $(".about");
    var $aboutExplorer = $(".explorer-window.about-explorer");

    var $work = $(".work");
    var $workExplorer = $(".explorer-window.work-explorer");

    var $contact = $(".contact");
    var $contactExplorer = $(".explorer-window.contact-explorer");
    var $contactForm = $contactExplorer.find("form");
    var $contactThanks = $contactExplorer.find(".thanks");
    var $contactTo = $contactExplorer.find(".contact-to");
    var $contactFrom = $contactExplorer.find("#email");
    var $contactMessage = $contactExplorer.find("#message");
    var $contactHoneypot = $contactExplorer.find("#firstname");
    var $contactSubmit = $contactExplorer.find(".contact-submit");
    var $contactStatus = $contactExplorer.find(".contact-status");

    var $awards = $(".fa-trophy");
    var $awardsExplorer = $(".explorer-window.awards-explorer");

    var explorerFlexQueued = false;
    var scheduleFrame = window.requestAnimationFrame || function(callback) {
        return window.setTimeout(callback, 16);
    };

    function queueExplorerFlexCheck() {
        if (explorerFlexQueued) {
            return;
        }
        explorerFlexQueued = true;
        scheduleFrame(function() {
            explorerFlexQueued = false;
            checkExplorerFlex();
        });
    }

    function bindExplorer($explorer) {
        if ($explorer.hasClass("visible")) {
            return;
        }

        $explorer.addClass("visible");
        $explorer.fadeIn();
        $explorer.focus();
        $explorer.css("transform", "scale(1)");

        $explorer.draggable({
            handle: ".window-header",
            containment: "parent",
            minHeight: 50,
            start: function() {
                $explorer.focus();
            }
        });

        if (!$explorer.hasClass("spotify-explorer")) {
            $explorer.resizable({
                containment: "parent",
                minHeight: 400,
                minWidth: 500,
                start: function() {
                    window.jqueryResizeActive = true;
                },
                resize: function() {
                    if ($(this).hasClass("work-explorer")) {
                        checkWorkApps($explorer);
                    }
                    if ($(this).hasClass("awards-explorer")) {
                        checkAwardsApps($explorer);
                    }
                    queueExplorerFlexCheck();
                },
                stop: function() {
                    window.jqueryResizeActive = false;
                }
            });
        }

        queueExplorerFlexCheck();
    }

    function checkExplorerFlex() {
        $(".explorer-window").each(function() {
            if ($(this).hasClass("visible")) {
                var $windowBody = $(this).find(".window-body");
                var height = $windowBody[0].clientHeight;
                var scrollHeight = $windowBody[0].scrollHeight;

                if (scrollHeight > height) {
                    $windowBody.addClass("block-override");
                } else {
                    $windowBody.removeClass("block-override");
                }
            }
        });
    }

    function unbindExplorer($explorer) {
        $explorer.removeClass("visible");
        $explorer.css("transform", "scale(0.8)");
        $explorer.fadeOut(500);

        if ($explorer.data("ui-draggable")) {
            $explorer.draggable("destroy");
        }

        if (!$explorer.hasClass("spotify-explorer") && $explorer.data("ui-resizable")) {
            $explorer.resizable("destroy");
        }
    }

    function setItemWidth($items, explorerWidth) {
        if (explorerWidth > 1200) {
            $items.css("width", "calc(20% - 30px)");
        } else if (explorerWidth > 800) {
            $items.css("width", "calc(33.33% - 30px)");
        } else if (explorerWidth > 600) {
            $items.css("width", "calc(50% - 30px)");
        } else {
            $items.css("width", "");
        }
    }

    function checkWorkApps($explorer) {
        setItemWidth($(".work-item"), $explorer.width());
    }

    function checkAwardsApps($explorer) {
        setItemWidth($(".award-item"), $explorer.width());
    }

    function resetContactState() {
        $contactForm.show();
        $contactThanks.hide();
        $contactExplorer.find(".error").removeClass("error");
        $contactStatus.removeClass("error success").text("");
    }

    function isValidEmail(value) {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value);
    }

    function getContactProvider() {
        return $.trim(($contactForm.attr("data-provider") || "formsubmit").toLowerCase());
    }

    function setContactSubmitState(isSubmitting) {
        $contactSubmit.prop("disabled", isSubmitting);
        $contactSubmit.toggleClass("disabled", isSubmitting);
        $contactSubmit.html(isSubmitting ? 'Sending <i class="fa fa-spinner fa-spin"></i>' : 'Send <i class="fa fa-send"></i>');
    }

    function setContactStatus(message, isError) {
        $contactStatus.removeClass("error success");
        if (!message) {
            $contactStatus.text("");
            return;
        }
        $contactStatus.addClass(isError ? "error" : "success").text(message);
    }

    function extractRequestError(jqXHR, fallbackText) {
        if (jqXHR && jqXHR.responseJSON && jqXHR.responseJSON.message) {
            return jqXHR.responseJSON.message;
        }
        if (jqXHR && jqXHR.responseJSON && jqXHR.responseJSON.error) {
            return jqXHR.responseJSON.error;
        }
        if (jqXHR && jqXHR.responseText) {
            try {
                var parsed = JSON.parse(jqXHR.responseText);
                if (parsed && parsed.message) {
                    return parsed.message;
                }
            } catch (_ignored) {}
        }
        return fallbackText || "Failed to send message.";
    }

    function sendContactViaApi(toValue, fromValue, messageValue) {
        var provider = getContactProvider();
        var endpoint = $.trim($contactForm.attr("data-endpoint"));
        var subject = "Message from TerminalExplore website";

        if (provider === "web3forms") {
            var accessKey = $.trim($contactForm.attr("data-access-key"));
            if (!accessKey) {
                return $.Deferred().reject({ responseJSON: { message: "Missing Web3Forms access key in data-access-key." } }).promise();
            }

            return $.ajax({
                url: endpoint || "https://api.web3forms.com/submit",
                method: "POST",
                contentType: "application/json; charset=UTF-8",
                dataType: "json",
                data: JSON.stringify({
                    access_key: accessKey,
                    email: toValue,
                    from_email: fromValue,
                    replyto: fromValue,
                    subject: subject,
                    message: messageValue,
                    botcheck: ""
                })
            });
        }

        return $.ajax({
            url: endpoint || ("https://formsubmit.co/ajax/" + encodeURIComponent(toValue)),
            method: "POST",
            dataType: "json",
            headers: {
                Accept: "application/json"
            },
            data: {
                _subject: subject,
                _replyto: fromValue,
                email: fromValue,
                message: messageValue,
                _captcha: "false"
            }
        });
    }

    function submitContactForm(event) {
        if (event) {
            event.preventDefault();
        }

        resetContactState();

        if ($.trim($contactHoneypot.val()) !== "") {
            return false;
        }

        var fromValue = $.trim($contactFrom.val());
        var messageValue = $.trim($contactMessage.val());
        var toValue = $.trim($contactTo.val()) || "contact@4ng3l.dev";
        var hasError = false;

        if (!isValidEmail(fromValue)) {
            $contactFrom.closest(".to-from-field").addClass("error");
            hasError = true;
        }

        if (messageValue.length < 3) {
            $contactMessage.addClass("error");
            hasError = true;
        }

        if (hasError) {
            return false;
        }

        setContactSubmitState(true);
        setContactStatus("Sending message...", false);

        sendContactViaApi(toValue, fromValue, messageValue)
            .done(function(response) {
                if (response && String(response.success).toLowerCase() === "false") {
                    setContactStatus(response.message || "Failed to send message.", true);
                    return;
                }
                setContactStatus("Message sent.", false);
                $contactForm.hide();
                $contactThanks.fadeIn(200);
                $contactForm[0].reset();
                $contactTo.val(toValue);
            })
            .fail(function(jqXHR) {
                var message = extractRequestError(
                    jqXHR,
                    "Failed to send message. Check form service configuration in index.html."
                );
                setContactStatus(message, true);
            })
            .always(function() {
                setContactSubmitState(false);
            });

        return false;
    }

    $trash.on("click", function() {
        bindExplorer($trashExplorer);
    });

    $about.on("click", function() {
        bindExplorer($aboutExplorer);
    });

    $work.on("click", function() {
        checkWorkApps($workExplorer);
        bindExplorer($workExplorer);
    });

    $contact.on("click", function() {
        resetContactState();
        bindExplorer($contactExplorer);
    });

    $awards.on("click", function() {
        checkAwardsApps($awardsExplorer);
        bindExplorer($awardsExplorer);
    });

    $contactForm.on("submit", submitContactForm);

    $close.on("click", function() {
        var $explorer = $(this).parents(".explorer-window");
        unbindExplorer($explorer);
    });

    $logo.on("click", function() {
        if ($logoMenu.hasClass("open")) {
            $logoMenu.animate({ left: "-200px" });
            $logoMenu.removeClass("open");
        } else {
            $logoMenu.animate({ left: "5" });
            $logoMenu.addClass("open");
        }
    });

    $shutdown.on("click", function() {
        var delay = 0;

        $(".explorer-window").each(function() {
            if ($(this).hasClass("visible")) {
                unbindExplorer($(this));
                delay = 500;
            }
        });

        setTimeout(function() {
            $screen.removeClass("zoom");
            $room.removeClass("zoom-out");
            $apps.stop(true, true).fadeOut(500);
            $info.stop(true, true).fadeOut(500);
            $noise.stop(true, true).fadeOut(500);
            $grid.stop(true, true).fadeOut(500, function() {
                $screen.hide();
            });
        }, delay);
    });

    $login.on("click", function() {
        $loginOverlay.addClass("zoom");
        $loginOverlay.fadeOut(500);
        $apps.fadeIn();
        $info.fadeIn();
    });

    $window.on("resize.explorer", queueExplorerFlexCheck);
});

$(function() {
    var $time = $(".time");
    var $date = $(".date");
    var clockTimerId = null;

    function pad2(value) {
        return value < 10 ? "0" + value : String(value);
    }

    function updateDateTime() {
        var now = new Date();
        var hours24 = now.getHours();
        var hours12 = hours24 % 12;
        var hours = hours12 === 0 ? 12 : hours12;
        var minutes = pad2(now.getMinutes());
        var seconds = pad2(now.getSeconds());
        var period = hours24 >= 12 ? " PM" : " AM";

        $time.text(hours + ":" + minutes + ":" + seconds + period);
        $date.text(pad2(now.getDate()) + "/" + pad2(now.getMonth() + 1) + "/" + now.getFullYear());
    }

    function startClock() {
        if (clockTimerId !== null) {
            return;
        }
        updateDateTime();
        clockTimerId = window.setInterval(updateDateTime, 1000);
    }

    function stopClock() {
        if (clockTimerId === null) {
            return;
        }
        window.clearInterval(clockTimerId);
        clockTimerId = null;
    }

    document.addEventListener("visibilitychange", function() {
        if (document.hidden) {
            stopClock();
        } else {
            startClock();
        }
    });

    startClock();
});
